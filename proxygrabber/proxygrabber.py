#!/bin/python3 

import requests
import json
import os
import time
from selenium import webdriver 
from selenium.webdriver import Chrome
from selenium.webdriver import ChromeOptions
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import Select
from selenium.common.exceptions import NoSuchElementException


def geonode():
	url = "https://proxylist.geonode.com/api/proxy-list?limit=500&page=2&sort_by=lastChecked&sort_type=desc"
	req = requests.get(url)
	res = req.text
	json_parse = json.loads(res)

	#check if geonode files exists
	try:
		file = open('geonode.txt', 'x')
	except FileExistsError:
		print("Found existing geonode.txt file, proceeding to deletion")
		os.system('rm geonode.txt')
	try:
		file = open('geonode2.txt', 'x')
	except FileExistsError:
		print("Found existing geonode2.txt file, proceeding to deletion")
		os.system('rm geonode2.txt')

	total = len(json_parse["data"])
	count = 0
	#print("Protocal\tIp address\tport")
	while count < total:
		ip = json_parse["data"][count]['ip']
		port = json_parse["data"][count]['port']
		protocal = json_parse["data"][count]['protocols'][0]
		#print(f"{protocal}\t{ip}\t{port}")
		file = open("geonode.txt", 'a')
		file.write('\n')
		file.write(f"{protocal}\t{ip}\t{port}")
		file.close()
		#ip:port format
		newfl = open("geonode2.txt", 'a')
		newfl.write('\n')
		newfl.write(f"{ip}:{port}")
		newfl.close()
		count = count + 1

geonode()

def spys():
	opt = webdriver.ChromeOptions()
	opt.add_extension('./CJPALHDLNBPAFIAMEJDNHCPHJBKEIAGM_1_59_0_0.crx')
	#opt.add_argument("--headless")
	driver = webdriver.Chrome(options=opt)
	driver.get("https://spys.one/en/socks-proxy-list/")
	time.sleep(15)
	"""try:
		count = 1
		while True:
			addrport = driver.find_element(By.XPATH, f"/html/body/table[2]/tbody/tr[4]/td/table/tbody/tr[2]/td[{count}]/font").text
			#print(addrport)
			count = count + 1
	except NoSuchElementException as e:
		print(e)"""
	#print("Selecting value ....")
	select = Select(driver.find_element(By.ID, 'xpp'))
	select.select_by_value('5')
	time.sleep(5)
	select = Select(driver.find_element(By.ID, 'xf5'))
	select.select_by_value('0')
	time.sleep(5)
	try:
		k = 3
		m = 0
		while True:
			addr = driver.find_element(By.XPATH, f"/html/body/table[2]/tbody/tr[4]/td/table/tbody/tr[{k}]/td[1]/font").text
			print(addr)
			addr = addr.split(':')
			ip = addr[0]
			port = addr[1]
			protocal = driver.find_element(By.XPATH, f"/html/body/table[2]/tbody/tr[4]/td/table/tbody/tr[3]/td[2]").text
			protocal = protocal.lower()
			#print(f"{protocal}\t{ip}\t{port}")
			k = k + 1
			m = m + 1
			#write to proxychains conf
			file = open("spys.txt", 'a')
			file.write('\n')
			file.write(f'{protocal}\t{ip}\t{port}')
	except NoSuchElementException as e:
		pass
	driver.quit()
	#print(m)
#spys()

time.sleep(5)

def check():
	opt = webdriver.ChromeOptions()
	driver = webdriver.Chrome()
	driver.get("https://proxyscrape.com/online-proxy-checker")
	time.sleep(10)

	copy = os.system('cat geonode2.txt | xclip -selection clipboard')
	filename = "checked_proxies.txt"
	print("Listing files in the directory ...")
	ls = os.system('ls ~/Downloads > ~/Downloads/list.txt')
	print("Reading list file...")
	time.sleep(2)
	with open("/home/ewaat/Downloads/list.txt", 'r') as f:
		file = f.read()
		file = file.split('\n')
		if "" in file:
			file.remove("")
		if filename in file:
			print("Deleting existing file....")
			os.system('rm /home/ewaat/Downloads/checked_proxies.txt')
	print("Deleting listing file ...")
	os.system('rm ~/Downloads/list.txt')

	text_area = driver.find_element(By.XPATH, "/html/body/div/div[3]/div[1]/div[2]/div/div/div/textarea")
	text_area.click()
	text_area.send_keys(Keys.CONTROL, 'v')
	click_out = driver.find_element(By.XPATH, "/html/body/div/div[3]/div[1]/div[1]/div/div[3]").click()
	scroll = driver.execute_script("window.scrollTo(513,300)")
	time.sleep(3)
	print("Checking for working proxies ....")
	start_check = driver.find_element(By.XPATH, "/html/body/div/div[3]/div[1]/div[2]/div/div/div/div/button").click()
	time.sleep(25)
	print("Scrolling")
	scroll = driver.execute_script("window.scrollTo(500,15500)")
	time.sleep(5)
	print("Downloading working proxies ...")
	download_working = driver.find_element(By.XPATH, "/html/body/div/div[3]/div[1]/div[2]/div/div/div/div/div").click()
	time.sleep(2)
	driver.quit()
	#mv downloaded file
	print("Moving file to proxygrabber")
	time.sleep(2)
	os.system('mv /home/ewaat/Downloads/checked_proxies.txt ~/Projects/pentestbucket/proxygrabber/')
	time.sleep(2)

	#check working from file
	"""with open("checked_proxies.txt", 'r') as f:
		checked = f.read()
		checked = checked.split('\n')
		size = len(checked)
		ip_addr = []
		for i in checked:
			checked_ip = checked[i].split(':')
			new_ip = checked[0]
			grep = os.system(f'grep ')"""



check()